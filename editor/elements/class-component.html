<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="class-component">

	<style>

	.head {
		width: 100%;
	}

	</style>

	<template>

        <div hidden$="{{hideAll}}">

			<template is="dom-repeat" items="{{ components }}" as="component">
				<div class="card">

					<div class="card-header">
						<div class="row">
							<div class="col-md-8 text-xs-center">
								<a class="btn btn-warning btn-sm head" role="button">
									{{component.name}}
								</a>
							</div>
							<div class="col-md-4 text-xs-right">
								<div id="id_{{index}}" class="btn-group">
									<button type="button" class="btn btn-primary dropdown-toggle btn-sm" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" on-click="scrollTo">
								    </button>
									<div class="dropdown-menu dropdown-menu-right">
										<h6 class="dropdown-header">Class options:</h6>
										<div class="dropdown-divider"></div>
										<a class="dropdown-item" href="#" on-click="resetClass" component="{{index}}">Reset</a>
										<a class="dropdown-item" href="#" on-click="deleteClass" component="{{index}}">Delete</a>
									</div>
								</div>
							</div>
						</div>
					</div>



					<div class="card-block">
						<div class="container-fluid">

							<template id="class-list" is="dom-repeat" items="{{ component.properties }}" filter="show" as="p">

								<!-- vector -->
								<div class="row" hidden$="{{hideProperty('Vec2', p)}}">

									{{p.name}} (vec2):</br>
									<template id="class-list" is="dom-repeat" items="{{ toArray(p.value) }}" as="v">
										<div class="col-md-6">
											<div class="form-group form-group-sm">
												<input class="form-control" type="number" step= "0.1" on-change="updateComponents" value="{{v::input}}">
											</div>
										</div>
									</template>

								</div>

								<!-- simple properties -->
								<div class="row" hidden$="{{hideProperty('Number', p)}}">
									<div class="col-md-12">
										<label>{{p.name}} (number)</label>
										<input class="form-control" type="number" on-change="updateComponents" value="{{p.value::input}}">
									</div>
								</div>

								<div class="row" hidden$="{{hideProperty('Boolean', p)}}">
									<div class="col-md-12">
										<label>{{p.name}} (bool)</label>
										<input class="checkbox" type="checkbox" on-change="updateComponents" checked="{{p.value::checked}}">
									</div>
								</div>


								<div class="row" hidden$="{{hideProperty('String', p)}}">
									<div class="col-md-12">
										<label>{{p.name}} (string)</label>
										<input class="form-control" type="text" on-change="updateComponents" value="{{p.value::input}}">
									</div>
								</div>

								<!-- array -->
								<div hidden$="{{hideProperty('Array', p)}}">
									{{p.name}} (array)</br>
									<template is="dom-repeat" items="{{ toArray(p.value) }}" as="v">

										<div class="row" hidden$="{{hideProperty('String', v)}}">
											<div class="col-md-12">
												<input class="form-control" type="number" on-change="updateComponents" value="{{v.value::input}}"></br>
											</div>
										</div>

										<div class="row" hidden$="{{hideProperty('Boolean', v)}}">
											<div class="col-md-12">
												<input class="checkbox" type="checkbox" on-change="updateComponents" checked="{{v.value::checked}}"></br>
											</div>
										</div>

										<div class="row" hidden$="{{hideProperty('String', v)}}">
											<div class="col-md-12">
												<input class="form-control" type="text" on-change="updateComponents" value="{{v.value::input}}"></br>
											</div>
										</div>


										<div hidden$="{{hideProperty('Vec2', v)}}">

											<div class="row">
												<template is="dom-repeat" items="{{ toArray(v.value) }}" as="vv">
													<div class="col-md-6">
														<div class="form-group form-group-sm">
															<input class="form-control" type="number" step= "0.1" on-change="updateComponents" value="{{vv::input}}">
														</div>
													</div>
												</template>
								            </div>

										</div>


									</template>
								</div>

								<!-- object -->
								<div hidden$="{{hideProperty('Object', p)}}">
									{{p.name}} (object)</br>
									<template is="dom-repeat" items="{{ toArray(p.value, 'Object') }}" as="v">

										<div class="row" hidden$="{{hideProperty('Number', v.value)}}">
											<div class="col-md-12">
												<label>{{v.name}} (number)</label>
												<input class="form-control" type="number" on-change="updateComponents" value="{{v.value::input}}"></br>
											</div>
										</div>

										<div class="row" hidden$="{{hideProperty('Boolean', v.value)}}">
											<div class="col-md-12">
												<label>{{v.name}} (bool)</label>
												<input class="checkbox" type="checkbox" on-change="updateComponents" checked="{{v.value::checked}}"></br>
											</div>
										</div>

										<div class="row" hidden$="{{hideProperty('String', v.value)}}">
											<div class="col-md-12">
												<label>{{v.name}} (string)</label>
												<input class="form-control" type="text" on-change="updateComponents" value="{{v.value::input}}"></br>
											</div>
										</div>


										<div class="row" hidden$="{{hideProperty('Vec2', v)}}">

											{{v.name}} (vec2):</br>
											<template is="dom-repeat" items="{{ toArray(v.value) }}" as="vv">
												<div class="col-md-6">
													<div class="form-group form-group-sm">
														<input class="form-control" type="number" step="0.1" on-change="updateComponents" value="{{vv::input}}">
													</div>
												</div>
											</template>

										</div>


									</template>
								</div>

							</template>
						</div>
					</div>
	            </div>

			</template>
        </div>

	</template>

</dom-module>

<script>

	Polymer({
		is: 'class-component',

		properties: {

			actor: {
				type: Object,
				value: null,
				notify: true,
				observer: 'refreshActor'
			},

			components: {
				type: Array,
				value: []
			},

			hideAll: {
				type: Boolean,
				value: true
			},

		},

		ready: function () { },

		// scrollTo: function(e) {
		// 	var id = e.target.parentNode.id;
		// 	$('#components-view').animate({
		// 		scrollTop: $("#" + id).offset().top
		// 	}, 1000);
		// },

		deleteClass: function(e) {
			var index = e.target.component;
			if(this.actor) this.actor.prefab.components.splice(index, 1);

			this.rebindComponents()
		},

		resetClass: function(e) {
			var index = e.target.component;
			var c = Amble._classes.find(c => c.name == this.components[index].name);
			if(c) {

				for(var x in c.properties) {
					this.actor.prefab.components[index].properties[x] = JSON.parse(JSON.stringify(c.properties[x]));
				}

				this.rebindComponents()
			}
		},

		show: function(item) {
			return (item && item.name && item.value && item.type);
		},

		toArray: function(obj, type) {
			if(Array.isArray(obj)) {
				return obj;
			} else if(type && type == 'Object'){
	            return Object.keys(obj).map(function(key) {
	                return {
	                    name: key,
	                    value: obj[key]
	                };
	            });

			} else {
				return [];
			}
		},

		hideProperty: function(type, property) {

			if(property.type) {
				return type != property.type;
			} else {
				return typeof property != type.toLowerCase();
			}
		},

		updateComponents: function(e) {
			this.actor.prefab.components = this.components;
		},

		refreshActor: function() {

			if(this.actor.sceneID) {
				var sceneID = this.actor.sceneID;
				this.actor = Amble.app.scene.getActorByID(sceneID);

				this.hideAll = this.actor.prefab.components.length == 0;

				this.rebindComponents()
			}
		},

		rebindComponents: function() {
			this.components = [];
			for(var i in this.actor.prefab.components) {
				this.push('components', this.actor.prefab.components[i]);
			}

		},

		hideComponenet: function() {},

	});

</script>
