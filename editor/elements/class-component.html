<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="class-component">

	<style>

	.head {
		width: 100%;
	}

	</style>

	<template>

        <div hidden$="{{hideAll}}">

			<template id="class-list" is="dom-repeat" items="{{ components }}" as="component">
				<div class="card">

					<div class="card-header">
						<div class="row">
							<div class="col-md-9 text-xs-center">
								<a class="btn btn-warning btn-sm head" role="button">
									{{component.name}}
								</a>
							</div>
							<div class="col-md-2 text-xs-right">
								<div id="id_{{index}}"class="btn-group">
									<button type="button" class="btn btn-primary dropdown-toggle btn-sm" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" on-click="scrollTo">
								    </button>
									<div class="dropdown-menu dropdown-menu-right">
										<h6 class="dropdown-header">Class options:</h6>
										<div class="dropdown-divider"></div>
										<a class="dropdown-item" href="#" on-click="resetClass">Reset</a>
										<a class="dropdown-item" href="#" on-click="deleteClass">Delete</a>
									</div>
								</div>
							</div>
						</div>
					</div>



					<div class="card-block">
						<div class="container-fluid">

							<template id="class-list" is="dom-repeat" items="{{ component.props }}" as="p">

								<!-- vector -->
								<div class="row" hidden$="{{hideProperty('vec2', p)}}">

									<div class="row">
										{{p.name}} (vec2):</br>
										<template id="class-list" is="dom-repeat" items="{{ p.value.value }}" as="v">
											<div class="col-md-6">
												<form class="form-horizontal">
													<div class="form-group form-group-sm">
														<input class="form-control" type="number" placeholder="{{v.name}}" property="{{p.name}}" id="{{v.name}}" step= "0.1" component="{{component.index}}" on-change="valuesChange" value="{{v.value}}">
													</div>
												</form>
											</div>
										</template>
						            </div>

								</div>

								<!-- simple properties -->
								<div class="row" hidden$="{{hideProperty('simple-number', p)}}">
									<div class="col-md-12">
										<label>{{p.name}} (number)</label>
										<input class="form-control" type="number" property="{{p.name}}" component="{{component.index}}" on-change="valuesChange" value="{{p.value}}">
									</div>
								</div>

								<div class="row" hidden$="{{hideProperty('simple-bool', p)}}">
									<div class="col-md-12">
										<label>{{p.name}} (bool)</label>
										<input class="checkbox" type="checkbox" property="{{p.name}}" component="{{component.index}}" on-change="valuesChange" checked="{{p.value}}">
									</div>
								</div>


								<div class="row" hidden$="{{hideProperty('simple-string', p)}}">
									<div class="col-md-12">
										<label>{{p.name}} (string)</label>
										<input class="form-control" type="text" property="{{p.name}}" component="{{component.index}}" on-change="valuesChange" value="{{p.value}}">
									</div>
								</div>

								<!-- array of simple -->
								<div class="row" hidden$="{{hideProperty('array', p)}}">
									{{p.name}} (array)</br>
									<template is="dom-repeat" items="{{ p.values }}" as="v">
										<div class="row" hidden$="{{hideProperty('simple-number', v)}}">
											<div class="col-md-12">
												<label>{{v.name}} (number)</label>
												<input class="form-control" type="number" property="{{p.name}}" index="{{v.name}}" component="{{component.index}}" on-change="valuesChange" value="{{v.value::input}}"></br>
											</div>
										</div>

										<div class="row" hidden$="{{hideProperty('simple-bool', v)}}">
											<div class="col-md-12">
												<label>{{v.name}} (bool)</label>
												<input class="checkbox" type="checkbox" property="{{p.name}}" index="{{v.name}}" component="{{component.index}}" on-change="valuesChange" checked="{{v.value}}"></br>
											</div>
										</div>

										<div class="row" hidden$="{{hideProperty('simple-string', v)}}">
											<div class="col-md-12">
												<label>{{v.name}} (string)</label>
												<input class="form-control" type="text" property="{{p.name}}" index="{{v.name}}" component="{{component.index}}" on-change="valuesChange" value="{{v.value::input}}"></br>
											</div>
										</div>

									</template>
								</div>

								<!-- array of vec2 -->
								<div class="row" hidden$="{{hideProperty('vec2-array', p)}}">
									{{p.name}} (array)</br>
									<template is="dom-repeat" items="{{ p.values }}" as="v">

										<div class="row">
											{{v.name}}</br>
											<template id="class-list" is="dom-repeat" items="{{ v.value.value }}" as="vv">
												<div class="col-md-6">
													<form class="form-horizontal">
														<div class="form-group form-group-sm">
															<input class="form-control" placeholder="{{vv.name}}" type="number" property="{{p.name}}" index="{{v.name}}" id="{{vv.name}}" step= "0.1" component="{{component.index}}" on-change="valuesChange" value="{{vv.value}}">
														</div>
													</form>
												</div>
											</template>
						                </div>
									</template>
								</div>

								<div class="divider"></div>

							</template>
						</div>
					</div>
	            </div>

			</template>
        </div>
	</template>
</dom-module>

<script>

	Polymer({
		is: 'class-component',

		properties: {

			actor: {
				type: Object,
				value: null,
				notify: true,
				observer: 'refreshActor'
			},

			hideAll: {
				type: Boolean,
				value: true
			},

			components: {
				type: Array,
				value: []
			}

		},

		ready: function () { },

		scrollTo: function(e) {
			var id = e.target.parentNode.id;
			$('#components-view').animate({
				scrollTop: $("#" + id).offset().top
			}, 1000);
		},

		deleteClass: function(e) {
			var index = e.target.component;

			if(this.actor) this.actor.prefab.components.splice(index, 1);

			this.components = [];
			for(var i in this.actor.prefab.components) {
				var c = this.actor.prefab.components[i];
				var p = [];
				for(var x in c.properties) {
					var a = this.decodeProperties(c.properties[x]);
					p.push(a);
				}

				this.push('components', {
					name: c.name,
					props: p
				});
			}
		},

		resetClass: function(e) {
			var index = e.target.component;
			var c = Amble._classes.find(c => c.name == this.components[index].name);
			if(c) {

				for(var x in c.properties) {
					this.actor.prefab.components[index].properties[x] = JSON.parse(JSON.stringify(c.properties[x]));
				}

				this.components = [];
				for(var i in this.actor.prefab.components) {
					var c = this.actor.prefab.components[i];
					var p = [];
					for(var x in c.properties) {
						var a = this.decodeProperties(c.properties[x]);
						p.push(a);
					}

					this.push('components', {
						name: c.name,
						props: p
					});
				}
			}
		},

		hideProperty: function(type, p) {

			switch(type) {

				case 'simple-number':
					return !(typeof p.value == 'number')
				break;

				case 'simple-bool':
					return !(typeof p.value == 'boolean')
				break;

				case 'simple-string':
					return !(typeof p.value == 'string')
				break;

				case 'vec2':
					return !(p.value && p.value.type && p.value.type === 'Vec2');
				break;

				case 'array':
					return !(Array.isArray(p.values) && typeof p.values[0].value != 'object');
				break;

				case 'vec2-array':
					return !(Array.isArray(p.values) && typeof p.values[0].value == 'object');
				break;

				default:
				return true;

				break;
			}

		},

		propertyUpdate: function(p, e) {
			if(typeof p.args[0] == 'number' || typeof p.args[0] == 'boolean' || typeof p.args[0] == 'string') {
				switch(e.target.type) {
					case 'number':
						return p.args[0] = Number(e.target.value)
					break;

					case 'text':
						return p.args[0] = e.target.value
					break;

					case 'checkbox':
						return p.args[0] = e.target.checked;
					break;
				}
			} else if (p.args[0].name == 'Array') { //array

				var index = Number(e.target.index);
				return p.args[0].args[index].args[0] = this.propertyUpdate(p.args[0].args[index], e);

			} else if(p.args[0].name == 'Vec2' ){
				var type = e.target.id;
				if(type == 'x') {
					p.args[0].args[0].args[0] = this.propertyUpdate(p.args[0].args[0], e)
				} else {
					p.args[0].args[1].args[0] = this.propertyUpdate(p.args[0].args[1], e)
				}
				return p.args[0];
			}
		},

		valuesChange: function(e) {
			//apply object changes to prefab
			console.log('value change')
			var index = e.target.component;
			var property = e.target.property;
			var component = this.actor.prefab.components[index];

			if(component) {

				var p = component.properties.find(p => p.name == property)
				p = this.propertyUpdate(p, e);

			}

		},

		decodeProperties: function(obj) {

			var o = {}
			for(var i in obj.args) {

				o.name = obj.name;

				if(typeof obj.args[i] == 'number' || typeof obj.args[i] == 'boolean' || typeof obj.args[i] == 'string') {

					o.value = obj.args[i];

				} else if(obj.args[i].name == 'Array') { //array

					o.values = [];
					for(var x in obj.args[i].args) {
						o.values.push(this.decodeProperties(obj.args[i].args[x]));
					}

				} else if(obj.args[i].name == "Vec2") { //object - for now vec2 only

					o.value = {
						type: 'Vec2',
						value: [
							{
								name: 'x',
								value: obj.args[i].args[0].args[0]
							},
							{
								name: 'y',
								value: obj.args[i].args[1].args[0]
							}
						]
					}
				}
			}
			return o;
		},

		refreshActor: function() {

			if(this.actor.sceneID) {
				var sceneID = this.actor.sceneID;
				this.actor = Amble.app.scene.getActorByID(sceneID);

				this.hideAll = !(this.actor.prefab.components.length > 0);

				this.components = [];

				for(var i = 0; i < this.actor.prefab.components.length; i++) {
					var c = this.actor.prefab.components[i];
					var p = [];
					for(var x in c.properties) {
						var a = this.decodeProperties(c.properties[x]);
						p.push(a);
					}

					this.push('components', {
						index: i,
						name: c.name,
						props: p
					});
				}

			}
		},

		hideComponenet: function() {},

	});

</script>
