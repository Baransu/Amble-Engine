<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="amble-checkbox.html">

<dom-module id="renderer-component">

	<style>

	.head {
		width: 100%;
	}

	</style>

	<template>

    <div class="card" hidden$="{{hideRenderer}}">

			<div class="card-header">
				<div class="row">
					<div class="col-md-8 text-xs-center">
						<a class="btn btn-success btn-sm head" role="button" on-click="toggle">
							{{actor.renderer._editorName}}
						</a>
					</div>
					<div class="col-md-4 text-xs-right">
						<div class="btn-group">
							<button type="button" class="btn btn-primary dropdown-toggle  btn-sm" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						      <span class="sr-only"></span>
						    </button>
							<div class="dropdown-menu dropdown-menu-right">
								<h6 class="dropdown-header">Renderer options:</h6>
								<div class="dropdown-divider"></div>
								<a class="dropdown-item" href="#" on-click="deleteRenderer">Delete</a>
							</div>
						</div>
					</div>
				</div>
			</div>

      <iron-collapse id="collapse">
        <div class="card-block" hidden$="{{hideContent}}">
  				<div class="container-fluid">

  					<!-- rect renderer -->
            <div hidden$="{{typeofRenderer('RectRenderer', actor.renderer)}}">

  						<div class="row">
  							<div class="col-md-6">
  								<div class="form-group form-group-sm">
  									<label>size x</label>
                    <input class="form-control" type="number" step="1" on-change="valuesChange" is="iron-input" bind-value="{{actor.renderer.size.x}}">
  								</div>
  							</div>
  							<div class="col-md-6">
  								<div class="form-group form-group-sm">
  									<label>size y</label>
                    <input class="form-control" type="number" step="1" on-change="valuesChange" is="iron-input" bind-value="{{actor.renderer.size.y}}">
                  </div>
  							</div>
  						</div>

  						<div class="row">
  							<div class="col-md-12">
  								<label>layer</label>
  								<input class="form-control" type="number" step="1" on-change="valuesChange" is="iron-input" bind-value="{{actor.renderer.layer}}">
  							</div>
  						</div>

  						<div class="row">
  							<div class="col-md-12">
  								<label>color</label>
  								<input class="form-control" type="text" on-change="valuesChange" is="iron-input" bind-value="{{actor.renderer.color}}">
  							</div>
  						</div>
  					</div>

  					<!-- sprite renderer -->
  					<div hidden$="{{typeofRenderer('SpriteRenderer', actor.renderer)}}">

  						<div class="row">
  							<div class="col-md-12">
  								<label>layer</label>
  								<input class="form-control" type="number" step="1" on-change="valuesChange" is="iron-input" bind-value="{{actor.renderer.layer}}"></br>
  							</div>
  						</div>

  						<div class="row">
  							<div class="col-md-12">
  								<label>sprite</label>
  								<select class="form-control" on-change="spriteChange">
  									<template is="dom-repeat" items="{{ sprites }}" as="sprite">
  										<option value="{{sprite.name}}" selected$="{{selected(sprite.name, actor.renderer.sprite)}}">
  											{{sprite.name}}
  										</option>
  									</template>
  								</select>
  							</div>
  						</div>

  					</div>

  					<!-- animation renderer -->
  					<div hidden$="{{typeofRenderer('AnimationRenderer', actor.renderer)}}">

  						<div class="row">
  							<div class="col-md-12">
                  <amble-checkbox id="play" checked="{{actor.renderer.play}}" on-click="valuesChange">play</amble-checkbox>
  								<!-- <label>play</label>
  								<input id="play" class="checkbox" type="checkbox" on-change="valuesChange"> -->
  							</div>
  						</div>

  						<div class="row">
  							<div class="col-md-12">
  								<label>layer</label>
                  <input class="form-control" type="number" step="1" on-change="valuesChange" is="iron-input" bind-value="{{actor.renderer.layer}}">
  							</div>
  						</div>

  						<div class="row">
  							<div class="col-md-12">
  								<label>frames</label>
  								<input class="form-control" type="number" step="1" min="1" on-change="valuesChange" is="iron-input" bind-value="{{actor.renderer.frames}}">
  							</div>
  						</div>

  						<div class="row">
  							<div class="col-md-12">
  								<label>updatesPerFrame</label>
  								<input class="form-control" type="number" step="1" min="0" on-change="valuesChange" is="iron-input" bind-value="{{actor.renderer.updatesPerFrame}}">
  							</div>
  						</div>


  						<div class="row">
  							<div class="col-md-12">
  								<label>sprite</label>
  								<select class="form-control" on-change="spriteChange">
  									<template is="dom-repeat" items="{{ sprites }}" as="sprite">
  										<option value="{{sprite.name}}" selected$="{{selected(sprite.name, actor.renderer.sprite)}}">
  											{{sprite.name}}
  										</option>
  									</template>
  								</select>
  							</div>
  						</div>

  					</div>
          </div>
  			</div>

      </iron-collapse>

    </div>

	</template>

</dom-module>

<script>

	Polymer({
		is: 'renderer-component',

		properties: {

			actor: {
				type: Object,
				value: null,
				notify: true,
				observer: 'refreshActor'
			},

			lastActorID: {
				type: String,
				value: ''
			},

			sprites: {
				type: Array,
				value: [],
				observer: 'spriteUpdate'
			},

			hideRenderer: {
				type: Boolean,
				value: true
			}
		},

		ready: function(){
			this.isRendererPresent();
      this.toggle();
		},

		deleteRenderer: function() {

			if(this.actor) {

				this.actor.prefab.renderer = { name: 'EngineRenderer', args: {}};

				var sceneID = this.actor.sceneID;
				var prefab = JSON.parse(JSON.stringify(this.actor.prefab));

				AMBLE.scene.remove(this.actor);
				this.actor = AMBLE.scene.instantiate(prefab);

				this.actor.selected = false;
				this.actor.sceneID = sceneID;

				this.isRendererPresent();
			}
		},

		valuesChange: function() {

			//apply object changes to prefab
			if(this.actor) {

				//layer
				this.actor.prefab.renderer.args.layer = this.actor.renderer.layer;
        AMBLE.scene.sort();
        //force scene to sort

				switch(this.actor.renderer.type) {
					case 'sprite':

						//sprite
						this.actor.prefab.renderer.args.sprite = this.actor.renderer.sprite;

					break;
					case 'animation':

						//sprite
						this.actor.prefab.renderer.args.sprite = this.actor.renderer.sprite;

						//frames
						this.actor.prefab.renderer.args.frames = this.actor.renderer.frames;

						//ups
						this.actor.prefab.renderer.args.updatesPerFrame = this.actor.renderer.updatesPerFrame;

						//play
						this.actor.prefab.renderer.args.play = this.actor.renderer.play = this.$.play.checked;
            this.notifyPath('actor.prefab.renderer.args.play', this.actor.prefab.renderer.play);
            console.log(this.actor.prefab.renderer.args.play, this.actor.renderer.play, this.$.play.checked);

					break;
					case 'rect':

						//color
						this.actor.prefab.renderer.args.color = this.actor.renderer.color;

						//size
						this.actor.prefab.renderer.args.size.args.x = this.actor.renderer.size.x;
            this.notifyPath('actor.prefab.renderer.args.size.args.y', this.actor.prefab.renderer.args.size.args.y);
						this.actor.prefab.renderer.args.size.args.y = this.actor.renderer.size.y;
            this.notifyPath('actor.prefab.renderer.args.size.args.y', this.actor.prefab.renderer.args.size.args.y);

					break;
				}
			}
		},


		spriteUpdate: function() {
			if(this.actor.renderer && (this.actor.renderer.type == 'sprite' || this.actor.renderer.type == 'animation') && !this.actor.renderer.sprite && this.sprites.length > 0) {
				this.actor.renderer.sprite = this.actor.prefab.renderer.args.sprite = this.sprites[0].name;
			}

		},

		typeofRenderer: function(type, current) {
			if(current._editorName == type) {
				return false;
			} else {
				return true;
			}
		},

		isRendererPresent: function(){

			if(this.actor.renderer && this.actor.renderer._editorName != 'EngineRenderer') {

				if(this.lastActorID != this.actor.sceneID)
					this.hideContent = false;

				this.lastActorID = this.actor.sceneID;

				this.hideRenderer = false;

				this.spriteUpdate();

			} else {
				this.hideRenderer = true;
			}
		},

		refreshActor: function() {

			if(this.actor.sceneID) {

				var sceneID = this.actor.sceneID;
				this.actor = AMBLE.scene.getActorByID(sceneID);

				this.updateSpritesList();

				this.spriteUpdate();

				this.valuesChange();
				this.isRendererPresent();
			}
		},

		updateSpritesList: function() {
			this.sprites = [];
			for(var i in AMBLE.imgList) {
				this.push('sprites', AMBLE.imgList[i])
			}
		},

		selected: function(item, type){
			return type == item;
		},

		spriteChange: function(e){

			if(this.actor instanceof Actor) {
				this.actor.renderer.sprite = e.target.value;

				this.actor.prefab.renderer.args.sprite = this.actor.renderer.sprite;
        this.notifyPath('actor.renderer.sprite', this.actor.renderer.sprite);
			}
		},

    toggle: function() {
      this.$.collapse.toggle();
    }

	});

</script>
